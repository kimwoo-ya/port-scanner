name: pnpm-deploy

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      targetStage:
        description: "ë°°í¬ í™˜ê²½"
        type: choice
        default: master
        required: true
        options: [master]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 30

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0"

      - name: Install pnpm
        run: npm install -g pnpm

      # Rust ì„¤ì¹˜
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # Linux ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      # Windows ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies (Windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          # WindowsëŠ” Visual Studio Build Toolsê°€ ê¸°ë³¸ ì œê³µë¨
          # ì¶”ê°€ ì˜ì¡´ì„±ì´ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— ì‘ì„±
          echo "Windows dependencies check"

      # macOS ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies (macOS only)
        if: matrix.platform == 'macos-latest'
        run: |
          # macOSëŠ” ëŒ€ë¶€ë¶„ì˜ ì˜ì¡´ì„±ì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ
          echo "macOS dependencies check"
      
      - uses: actions/cache@v4
        id: cache
        with:
          path: |
            node_modules
            .pnpm-store
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: pnpm install

      ##############################################
      # Release ìƒì„± & ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ
      ##############################################
      - name: Build & Upload to GitHub Releases
        uses: tauri-apps/tauri-action@v0
        with:
          tagName: app-v__VERSION__
          releaseName: "App v__VERSION__"
          releaseBody: |
            ìë™ ë°°í¬ëœ Tauri ì•± ë¹Œë“œì…ë‹ˆë‹¤.
            ## ğŸ”§ macOSì—ì„œ ì‹¤í–‰ì´ ë§‰í ê²½ìš°
            ë§¥ì—ì„œ ì´ ì•±ì„ ì²˜ìŒ ì‹¤í–‰í•˜ë©´ Appleì˜ ê°œë°œì ID ì„œëª… ëˆ„ë½ìœ¼ë¡œ ì¸í•´
            â€˜"port-scanner.app"ì€(ëŠ”) ì†ìƒë˜ì—ˆê¸° ë•Œë¬¸ì— ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ í•­ëª©ì„ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤.â€™ ë¼ëŠ” ê²½ê³ ê°€ ë‚˜ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ì´ëŸ´ ë•Œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ë§¥ì´ ì˜ëª» ì¸ì‹í•œ ë³´ì•ˆ í‘œì‹œë¥¼ ì§€ì›Œ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
            ```shell
            xattr -cr /Applications/port-scanner.app
            ```
            í„°ë¯¸ë„ì— ì´ ëª…ë ¹ì–´ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ê³  ì‹¤í–‰í•´ì£¼ì„¸ìš”.
          releaseDraft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
